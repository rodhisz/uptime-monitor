name: Uptime Monitor

on:
  schedule:
    # Run every 1 minute
    - cron: '*/1 * * * *'
  workflow_dispatch: # Allows manual run from GitHub UI
    inputs:
      test_mode:
        description: 'Run in Test Mode (Send test notification)'
        required: false
        type: boolean
        default: false

jobs:
  check-uptime:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Important: Allows the action to commit to the repo
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Uptime Check
        env:
          TARGET_URL: ${{ secrets.TARGET_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            python check_uptime.py --test
          else
            python check_uptime.py
          fi

      - name: Commit and Push Status
        if: always() # Run even if the script fails (although script now returns True always, safety first)
        run: |
          git config --global user.name 'Uptime Monitor Bot'
          git config --global user.email 'uptime-bot@users.noreply.github.com'
          git add uptime_status.json || true
          git commit -m "Update uptime status" || echo "No changes to commit"
          git push
